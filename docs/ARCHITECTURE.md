## CKD清单核对工具 - 架构与技术设计说明

### 1. 整体架构概览

- **前端层**：`Streamlit` 单页应用，负责文件上传、参数配置、结果展示与报告下载。
- **应用层（业务逻辑）**：集中在 `modules/` 目录，完成配置加载、文件读取、智能列映射、差异比对、结果整合等。
- **Excel 解密 / IO 层**：基于 `xlwings` 与 Excel/WPS COM 接口，负责对绿盾等加密工作簿的解密与数据拉取。
- **持久化层**：仅使用临时文件系统（`tempfile`），不做业务数据落库，重点在于安全销毁与线程安全。

数据流大致为：

1. 浏览器通过 `Streamlit` 上传 BOM 与多份清单文件（`BytesIO`）。
2. 服务器端将文件写入临时目录（保证与 Excel COM 的兼容性）。
3. `xlwings` 在加锁环境下启动不可见 Excel 实例，打开文件触发解密。
4. 通过 `used_range` 读取所有单元格为二维列表，交给 `pandas` 做进一步清洗与结构化。
5. `data_processor` 按业务规则完成核对与状态判定，结果写回 `xlsxwriter` 报表。
6. `Streamlit` 将生成的 Excel 报告通过下载按钮回传给浏览器。

---

### 2. 模块划分与职责

- `main.py`
  - Streamlit 入口
  - 页面布局与交互逻辑（文件上传、参数面板、按钮、结果展示）
  - 调用 `modules` 中的核心能力完成核对与报告生成

- `modules/config.py`
  - 全局常量：状态枚举、关键字池、默认配置等
  - Smart Anchor 所需的字段关键词及权重定义

- `modules/utils.py`
  - 通用工具方法：字符串清洗、算式解析、打分逻辑等
  - 用于 Smart Anchor 的打分与最优表头定位

- `modules/file_reader.py`
  - 统一文件读取入口：`GenericListLoader`
  - 解密服务器实现：`threading.Lock` + `xlwings` + `tempfile`
  - 将原始 Excel 转换为统一的 `pandas.DataFrame`

- `modules/ui_helper.py`
  - 智能列映射 UI：根据 Smart Anchor 自动预判列，再由用户在下拉框中确认
  - 多清单场景下的动态表单构建与状态维护

- `modules/data_processor.py`
  - 核心比对引擎：五种状态判定、替代料合并、方向双向核对
  - 报告生成：分 Sheet 输出汇总、各清单结果、BOM 数据

---

### 3. 关键技术点

- **Smart Anchor 智能表头定位**
  - 在前 N 行（如 20 行）中扫描所有单元格
  - 根据自定义关键字字典与匹配规则进行打分
  - 综合多个指标（关键词、相似度、位置等）确定表头行与字段列

- **替代料深度融合**
  - 在 BOM 中维护主料及其所有替代料关系
  - 清单侧将主料 + 替代料数量汇总后，与 BOM 需求量进行对比
  - 支持输出“使用替代料明细”，保证业务可追溯

- **多清单并行核对**
  - 同一 BOM 下可上传多份清单（多线、多工序、多供应商）
  - 每个清单有独立的列映射配置与核对结果
  - 汇总 Sheet 中统计各清单通过率与异常情况

- **解密服务器与线程安全**
  - 使用 `threading.Lock()` 保证同一时间只有一个 Excel COM 会话
  - 所有临时文件在 `try...finally` 中删除，避免泄露敏感数据
  - Excel 实例使用不可见模式，避免服务器弹出窗口

---

### 4. 可扩展方向（面试可聊）

- 接入数据库，持久化历史工单与核对结果，支持查询与看板统计
- 增加用户与权限体系，按角色控制可见项与操作范围
- 把核对引擎抽象成独立服务（如 FastAPI），Streamlit 仅做前端壳
- 增加自动化测试与 CI 流水线，提升工程质量与可维护性

