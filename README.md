## CKD清单核对工具 v5.0 极简版

一个基于 **Streamlit + xlwings + pandas** 的 **BOM ↔ 清单自动核对工具**，面向制造业/电子行业场景，支持多清单并行、替料合并、绿盾加密 Excel 自动解密等能力。

该项目适合作为个人作品集展示以下能力：

- **端到端解决方案设计**：从浏览器上传 → 服务器解密 Excel → 数据清洗与比对 → 生成多 Sheet 报告
- **复杂业务规则建模**：五种物料状态判定、替代料深度融合、多清单多维统计
- **工程化实践**：模块化代码结构、配置与常量集中管理、解密服务器线程安全控制

---

## 🧭 项目概览（Portfolio 视角）

- **应用场景**：
  - 生产现场核对 BOM 与各类 CKD 物料清单（入库、出库、工单、供应商清单等）
  - 快速发现 **数量差异、缺料、超 BOM 物料、替代料使用情况**
- **角色定位**：
  - 既可作为 **内部工具**（在企业内网部署）
  - 也可作为 **个人技术作品**，展示对制造业业务与数据处理的理解
- **典型价值**：
  - 将原本需要人工对比数小时的工作，缩短到 **秒级/分钟级** 自动核对

---

## 🆕 v5.0 极致精简亮点

- 🧹 **统一读取器** — 所有清单统一为 `GenericListLoader`，逻辑零冗余
- 🧠 **智能列映射** — 完全依赖 Smart Anchor 自动检测，仅保留下拉框确认
- 📂 **多清单支持** — 一次上传多个清单文件，独立映射配置，批量比对
- 🗂️ **箱号双模式** — 下拉可选"标准列"或"🔄 流式解析"
- 🔐 **解密服务器** — 上传 → 落盘 → xlwings 解密 → 读取 → 销毁
- 🧼 **极简UI** — 移除诊断信息、配置项、服务器状态，专注核对核心功能

---

## 📋 核心功能

| 特性 | 说明 |
|------|------|
| 智能表头定位 | Smart Anchor 自动扫描前20行，关键词打分定位表头 |
| 智能列映射 | 自动预判"料号/数量/箱号"列，用户仅需确认下拉框 |
| 多清单并行核对 | 一次上传多个清单，各自独立映射、独立比对 |
| 解析双轨制 | 标准列模式 / 流式分箱模式 |
| 五种状态判定 | OK · OK(含替料) · NG(差异) · NG(缺料) · NG(BOM无) |
| 替代料深度融合 | 主料+所有替料求和比对 |
| 绿盾兼容 | xlwings 借壳 Excel COM 自动解密 |
| Excel 多Sheet报告 | 汇总 + 各清单核对结果 + BOM数据 |

---

## 🚀 快速开始（本地运行）

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行程序

```bash
streamlit run main.py
```

### 3. 操作步骤

1. **上传文件**
   - 左侧：拖入 BOM 清单
   - 右侧：拖入待核对清单（**可多选**，Ctrl/Cmd+点击）

2. **确认列映射**
   - 系统自动识别表头行和各列位置
   - 左列：BOM 列映射（料号/数量/替代料/名称）
   - 右列：清单列映射（为每个文件独立配置）
   - 下拉框显示自动预判结果，若正确直接进入下一步

3. **点击"开始核对"**
   - 系统自动解析 BOM + 所有清单
   - 执行双向比对
   - 生成五种状态判定

4. **查看结果**
   - 统计卡片：BOM总数 + 各清单通过率 + 替料使用数
   - 结果表格：单清单直接展示，多清单 Tab 页切换
   - 可筛选"仅异常"或"全部"

5. **下载报告**
   - 点击"📥 下载 Excel 报告"
   - 包含汇总 + 各清单核对 + BOM数据

---

## 📁 项目结构与模块职责

```
CKD清单核对/
├── main.py                    # Streamlit 极简入口
├── requirements.txt           # 依赖库
├── README.md                  # 项目文档
└── modules/
    ├── __init__.py            # 模块包导出
    ├── config.py              # 全局配置（关键词池、状态常量）
    ├── utils.py               # 通用工具（清洗、算式、打分定位）
    ├── file_reader.py         # Excel 读取（解密服务器 + 统一解析器）
    ├── ui_helper.py           # 智能列映射 UI（自动预判 + 下拉确认）
    └── data_processor.py      # 核心比对引擎（五种状态 + 报告导出）
```

---

## 🎯 五种全场景状态判定

| 状态 | 说明 | 备注示例 |
|------|------|----------|
| **OK** | 数量一致，使用主料 | - |
| **OK (含替料)** | 数量一致，使用了BOM定义的替代料 | 使用替代料: 456789 |
| **NG (数量差异)** | BOM与清单均有，但数量不符 | 欠量 -50 |
| **NG (缺料)** | BOM有需求，清单完全未出现 | 清单中未找到该料号及其替代料 |
| **NG (BOM无)** | 清单中出现了BOM之外的料号 | 疑似技术变更或异常混料 |

---

## 🔐 解密服务器架构与线程安全

```
浏览器上传 (BytesIO)
       │
       ↓
tempfile 落盘到服务器临时目录
       │
       ↓
threading.Lock() 加锁 → xlwings 启动不可见 Excel → 打开临时文件（触发绿盾解密）
       │
       ↓
sheet.used_range.options(numbers=str).value → 原始二维列表
       │
       ↓
workbook.close() → app.quit() → os.remove(临时文件) [try…finally 保障]
```

---

## 📂 多清单并行核对

### 使用场景

- **多条线清单**：同一批次物料分多条生产线，各自独立清单
- **多工序清单**：入库清单、出库清单、品检清单等
- **多供应商清单**：不同供应商提供的物料清单

### 操作方式

1. 在"待核对清单"上传框按住 **Ctrl (Windows) / Cmd (Mac)**
2. 点选多个 Excel 文件（如 `清单A.xlsx`, `清单B.xlsx`, `清单C.xlsx`）
3. 每个文件独立显示列映射配置区域
4. 点击"开始核对"后，系统批量处理所有清单
5. 结果以 Tab 页分别展示

---

## 📊 输出报告

导出的 Excel 报告包含以下 Sheet：

| Sheet名称 | 内容 |
|-----------|------|
| 汇总 | 工单信息、各清单统计、通过率 |
| 清单1名称 | 第一个清单的详细比对结果（带条件格式） |
| 清单2名称 | 第二个清单的详细比对结果 |
| ... | ... |
| BOM数据 | 原始BOM数据（含替代料） |

---

## ⚠️ 运行环境与注意事项

1. **Excel 环境** — 服务器需安装 Microsoft Excel 或 WPS
2. **文件格式** — 支持 `.xlsx` / `.xls`，上传后自动解密
3. **并发限制** — 同一时间仅允许一个 Excel COM 进程（`threading.Lock`）
4. **数据清洗** — 自动处理前缀单引号、科学计数法、不可见字符
5. **Smart Anchor** — 完全自动检测表头行，无需手动配置
6. **多清单配置** — 每个清单独立配置列映射，确保准确性

---

## 🛠️ 技术栈与工程实践

- **Streamlit** — Web UI 框架
- **xlwings** — Excel COM 读取（绕过绿盾）
- **pandas** — 数据处理
- **xlsxwriter** — Excel 报告生成

---

## 📝 版本历史

### v5.0.0 (2026-02)
- 🧹 归一化重构：所有清单统一为 `GenericListLoader`
- 🧠 智能列映射：完全依赖 Smart Anchor，仅保留下拉框确认
- 📂 多清单并行核对：一次上传多个文件
- 🧼 极致精简：移除服务器状态显示、解析诊断、表头行号输入、数据预览
- 🔐 保持解密服务器架构

### v4.0.0 (2026-02)
- 🔐 解密服务器架构（上传→落盘→xlwings→销毁）
- 📤 File Uploader 替代 Tkinter 弹窗
- 📥 st.download_button 浏览器端下载

### v3.0.0 (2026-02)
- 🆕 智能表头定位（Smart Anchor）
- 🆕 解析双轨制
- 🆕 五种全场景状态判定
- 🆕 替代料深度融合

### ……

---

## 💡 设计哲学与可展示亮点

**极致精简** — 移除一切非核心的UI元素，专注于"核对"这一核心目的：

- ❌ **不需要** 服务器状态常驻显示 → 环境异常在执行时提示
- ❌ **不需要** 解析诊断信息 → 用户只关心最终结果
- ❌ **不需要** 手动选择表头行号 → Smart Anchor 自动检测
- ❌ **不需要** 数据预览 → 列映射下拉框已足够明确
- ✅ **只需要** 上传 → 确认 → 核对 → 下载

**界面视觉干扰降低 60%+**，操作流程纯粹而高效。

